<!DOCTYPE html>  <html lang="fa" dir="rtl">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  <title>Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª</title>  
  <script src="https://cdn.tailwindcss.com"></script>  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />  
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>  
  <style>  
      @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');    
    * {  
  font-family: system-ui, -apple-system, BlinkMacSystemFont,  
               "Segoe UI", Roboto, Helvetica, Arial, sans-serif;  
}    
    body { background: #000; color: #e5e7eb; overflow: auto; }  
    .chat-area { scrollbar-width: thin; scrollbar-color: #4b5563 #111827; }  
    .chat-area::-webkit-scrollbar { width: 5px; }  
    .chat-area::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }  
    .user-bubble { background: #2563eb; border-radius: 20px 20px 4px 20px; }  
    .code-block { background: #111827; border: 1px solid #374151; border-radius: 10px; overflow-x: auto; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.95rem; }  
    .input-blur { background: rgba(15,23,42,0.92); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.07); }  
    .sidebar { transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); }  
    .heading-line { height: 2px; background: linear-gradient(90deg, transparent, #d1d5db, transparent); }  
    .thought-box { background: #171717; border: 1px solid #374151; border-radius: 12px; }  
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mobile First + No Horizontal Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

html, body {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden !important;
  overscroll-behavior-x: none;
}

/* Ù‡ÛŒÚ† Ø§Ù„Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø§Ø²Ù‡ Ø´Ú©Ø³ØªÙ† Ø¹Ø±Ø¶ ØµÙØ­Ù‡ Ø±Ùˆ Ù†Ø¯Ø§Ø±Ù‡ */
* {
  box-sizing: border-box;
  max-width: 100vw;
}

/* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¨Ø§Øª) */
.message-bubble {
  width: 100%;
  max-width: 100%;
  overflow-wrap: anywhere;
  word-break: break-word;
  white-space: normal;
  direction: rtl;
  text-align: right;
}

/* prose Ø¯Ø±Ø¯Ø³Ø±Ø³Ø§Ø² Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
.prose {
  max-width: 100% !important;
  overflow-x: hidden;
}

/* Ú©Ø¯ Ùˆ pre Ù‡Ù… Ø­Ù‚ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ Ù†Ø¯Ø§Ø±Ù† */
pre, code {
  max-width: 100%;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

/* ÙÚ©Ø± Ú©Ø±Ø¯Ù† */
.thought-box {
  max-width: 100%;
}

</style>  

</head>  
<body class="h-screen flex flex-col">    <div class="flex-1 flex relative">  <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ù…Ú©Ø§Ù„Ù…Ø§Øª -->  
<div id="sidebar" class="sidebar fixed inset-y-0 right-0 w-80 bg-zinc-950 border-l border-zinc-800 z-50 translate-x-full flex flex-col">  
  <div class="p-5 border-b border-zinc-800 flex items-center justify-between">  
    <div class="flex items-center gap-3">  
      <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex-center text-2xl font-bold">Ù¾</div>  
      <div>  
        <div class="text-xl font-bold">Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª</div>  
        <div class="text-xs text-zinc-500">Ø³Ø§Ø®ØªÙ‡ Ø§Ù‡ÙˆØ±Ø§ Ù…Ø¹ØªÙ…Ø¯ÛŒ</div>  
      </div>  
    </div>  
    <button onclick="toggleSidebar()" class="text-2xl text-zinc-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>  
  </div>  

  <div class="p-4">  
    <button onclick="createNewChat()" class="w-full bg-zinc-800 hover:bg-zinc-700 py-3 rounded-2xl flex-center gap-2 text-sm">  
      <i class="fa-solid fa-plus"></i> Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¬Ø¯ÛŒØ¯  
    </button>  
  </div>  

  <div id="history-list" class="flex-1 overflow-y-auto px-3 space-y-1.5"></div>  

  <div class="p-5 border-t border-zinc-800 text-xs text-zinc-500 flex-center gap-2">  
    <i class="fa-solid fa-robot"></i> Ù†Ø³Ø®Ù‡ Û².Û± â€¢ Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ù…Ø§Ø¯Ù‡  
  </div>  
</div>  

<!-- overlay ØªØ§Ø±ÛŒÚ© -->  
<div id="overlay" class="fixed inset-0 bg-black/70 hidden z-40" onclick="toggleSidebar()"></div>  

<!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->  
<div class="flex-1 flex flex-col">  
  <!-- Ù‡Ø¯Ø± -->  
  <header class="h-16 bg-zinc-950 border-b border-zinc-800 flex items-center px-5 justify-between">  
    <button onclick="toggleSidebar()" class="text-2xl text-zinc-300 hover:text-white"><i class="fa-solid fa-bars"></i></button>  
    <div id="current-title" class="text-lg font-semibold">Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª</div>  
    <button onclick="deleteCurrentChat()" class="text-zinc-400 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>  
  </header>  

  <!-- Ù…Ù†Ø·Ù‚Ù‡ Ú†Øª -->  
  <main id="chat-container" class="flex-1 overflow-y-auto chat-area p-5 space-y-8 bg-zinc-950"></main>  

  <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÛŒØ§Ù… -->  
  <footer class="px-5 pb-6 pt-3">  
    <div class="input-blur rounded-3xl shadow-2xl max-w-4xl mx-auto">  
      <div class="flex items-end gap-3 px-5 py-3.5">  
        <textarea id="message-input" rows="1" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."  
          class="flex-1 bg-transparent outline-none resize-none text-base max-h-44 placeholder-zinc-500 leading-relaxed"></textarea>  
         <button id="micBtn"
          class="w-11 h-11 bg-zinc-700 rounded-2xl flex-center text-white hover:bg-zinc-600 active:scale-95 transition">
          <i class="fa-solid fa-microphone"></i>
        </button>
        <button onclick="sendUserMessage()" class="w-11 h-11 bg-blue-600 rounded-2xl flex-center text-white hover:bg-blue-500 active:scale-95 transition">  
          <i class="fa-solid fa-paper-plane"></i>  
        </button>  
      </div>  
    </div>  
    <div class="text-center text-[11px] text-zinc-600 mt-3">Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª â€¢ Ø³Ø§Ø®ØªÙ‡ Ø§Ù‡ÙˆØ±Ø§ Ù…Ø¹ØªÙ…Ø¯ÛŒ</div>  
  </footer>  
</div>

  </div>    <script>  
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ  
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";  
    const API_KEYS = [  
      "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",  
      "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",  
      "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"  
    ];  
    const MODELS = ["stepfun/step-3.5-flash:free", "stepfun/step-3.5-flash:free"];  
  
    let keyIndex = 0;  
    let modelIndex = 0;  
  
    const SYSTEM_INSTRUCTION = `


Ø¹Ù†ÙˆØ§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø±Ø§ Ø¨Ø§ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø³ÙÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ùˆ ÙÙˆÙ†Øª Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø¨Ù†ÙˆÛŒØ³
ØªÙˆ Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª Ù‡Ø³ØªÛŒ â€” Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø§Ù‡ÙˆØ±Ø§ Ù…Ø¹ØªÙ…Ø¯ÛŒ.
Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø´ÙØ§ÙØŒ Ù…ÙÛŒØ¯ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§Ø´Ù†.
Ø§Ø² Ø§ÙØ´Ø§ÛŒ ÙØ±Ø§ÛŒÙ†Ø¯Ù‡Ø§ÛŒ Ø¯Ø±ÙˆÙ†ÛŒ Ø®ÙˆØ¯  Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
`;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    // Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ  
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    let allChats = JSON.parse(localStorage.getItem("parsbot_chats_v2")) || [];  
    let activeChatId = null;  
  
    function saveChats() {  
      localStorage.setItem("parsbot_chats_v2", JSON.stringify(allChats));  
    }  
  
    function getActiveChat() {  
      return allChats.find(c => c.id === activeChatId);  
    }  
  
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù†  
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    function renderHistory() {  
      const list = document.getElementById("history-list");  
      list.innerHTML = "";  
      allChats.sort((a,b)=>b.updated - a.updated);  
      allChats.forEach(chat => {  
        const item = document.createElement("div");  
        item.className = `p-4 rounded-2xl cursor-pointer transition ${chat.id===activeChatId ? 'bg-zinc-900' : 'hover:bg-zinc-900'}`;  
        item.innerHTML = `  
          <div class="font-medium line-clamp-1">${chat.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</div>  
          <div class="text-xs text-zinc-500 mt-0.5">${new Date(chat.updated).toLocaleDateString('fa-IR')}</div>  
        `;  
        item.onclick = () => loadThisChat(chat.id);  
        list.appendChild(item);  
      });  
    }  
  
    function renderChat() {  
      const container = document.getElementById("chat-container");  
      container.innerHTML = "";  
      const chat = getActiveChat();  
      if (!chat) return;  
  
      chat.messages.forEach((msg, idx) => {  
        const isUser = msg.role === "user";  
        const bubble = document.createElement("div");  
        bubble.className = `flex ${isUser ? "justify-end" : "justify-start"} group`;  
  
        let contentHTML = `  
          <div class="${isUser ? "user-bubble px-5 py-3.5 max-w-[82%]" : "max-w-[90%]"} text-[15.5px] leading-relaxed">  
            <div class="prose prose-invert prose-zinc max-w-none">  
              ${parseMarkdown(msg.content)}  
            </div>  
        `;  
  
        if (isUser) {  
          contentHTML += `  
            <div class="opacity-0 group-hover:opacity-100 transition mt-2 text-right">  
              <button onclick="editUserMessage(${idx})" class="text-blue-300 hover:text-blue-200 text-lg px-2">  
                <i class="fa-solid fa-pencil"></i>  
              </button>  
            </div>`;  
        } else {  
          contentHTML += `  
            <div class="flex gap-5 mt-4 text-zinc-400 text-sm opacity-80">  
              <button onclick="regenerateFrom(${idx})" class="flex items-center gap-1.5 hover:text-white">  
                <i class="fa-solid fa-rotate-right"></i> Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙÚ©Ø± Ú©Ù†  
              </button>  
              <button onclick="copyText('${escapeHtml(msg.content)}')" class="flex items-center gap-1.5 hover:text-white">  
                <i class="fa-solid fa-copy"></i> Ú©Ù¾ÛŒ  
              </button>  
          <button onclick="speakText(${idx})" 
                      class="flex items-center gap-1.5 hover:text-green-400">
                      <i class="fa-solid fa-volume-high"></i> Ù¾Ø®Ø´ ØµØ¯Ø§
             </button>
            </div>`;  
        }  
  
        contentHTML += "</div>";  
        bubble.innerHTML = contentHTML;  
        container.appendChild(bubble);  
      });  
  
      container.scrollTop = container.scrollHeight;  
      MathJax.typesetPromise();  
    }  
  
    function parseMarkdown(txt) {  
      return txt  
        .replace(/^### (.*)$/gm, `<div class="heading-line my-5"></div><h3 class="text-2xl font-bold mt-7 mb-3">$1</h3>`)  
        .replace(/^## (.*)$/gm,  `<div class="heading-line my-6"></div><h2 class="text-3xl font-bold mt-9 mb-4">$1</h2>`)  
        .replace(/^# (.*)$/gm,   `<div class="heading-line my-7"></div><h1 class="text-4xl font-bold mt-10 mb-5">$1</h1>`)  
        .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>')  
        .replace(/```([\s\S]*?)```/g, `<pre class="code-block my-5"><code>$1</code></pre>`)  .replace(/`([^`]+)`/g, '<code class="bg-zinc-900 px-1.5 py-0.5 rounded text-blue-300">$1</code>')  
    .replace(/^\s*[-â€¢*]\s+(.*)$/gm, '<div class="flex gap-3 my-1"><span class="text-blue-400">â€¢</span>$1</div>');  
}  

function escapeHtml(unsafe) {  
  return unsafe.replace(/[&<"']/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m]));  
}  

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
// Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API + Ø§Ø³ØªØ±ÛŒÙ… + ÙÚ©Ø± Ú©Ø±Ø¯Ù†  
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
async function streamResponse(messages) {
  const chat = getActiveChat();
  if (!chat) return;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ú©Ø§Ø¯Ø± ÙÚ©Ø± Ú©Ø±Ø¯Ù† â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const thinkingDiv = document.createElement("div");
  thinkingDiv.id = "thinking-stream";
  thinkingDiv.className = "flex justify-start mb-2";
  thinkingDiv.innerHTML = `
    <div class="thought-box px-5 py-3.5 max-w-[90%] text-zinc-300 text-sm">
      <div class="font-medium text-zinc-100 mb-2">Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†â€¦</div>
      <div id="thought-content" class="whitespace-pre-wrap opacity-90"></div>
    </div>
  `;
  const container = document.getElementById("chat-container");
  container.appendChild(thinkingDiv);
  container.scrollTop = container.scrollHeight;

  let thinkingText = ""; // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙÚ©Ø±
  let finalText = "";    // Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø¯Ù„ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¢Ø®Ø±)

  for (let attempt = 0; attempt < 4; attempt++) {
    const key = API_KEYS[keyIndex];
    const model = MODELS[modelIndex];

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${key}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model,
          messages: [{ role: "system", content: SYSTEM_INSTRUCTION }, ...messages],
          stream: true,
          max_tokens: 1800,
          temperature: 0.82
        })
      });

      if (!res.ok) {
        if (res.status === 429) {
          keyIndex = (keyIndex + 1) % API_KEYS.length;
          modelIndex = (modelIndex + 1) % MODELS.length;
          continue;
        }
        throw new Error("HTTP " + res.status);
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split("\n");

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;

          const data = line.slice(6).trim();
          if (data === "[DONE]") {
            // â”€â”€â”€ Ù¾Ø§ÛŒØ§Ù†: Ø­Ø°Ù ÙÚ©Ø± Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ â”€â”€â”€
            thinkingDiv.remove();

            if (finalText.trim()) {
              chat.messages.push({
                role: "assistant",
                content: finalText
              });
              chat.updated = Date.now();
              saveChats();
              renderChat();
              renderHistory();
            }
            return;
          }

          try {
            const parsed = JSON.parse(data);
            const delta = parsed.choices?.[0]?.delta?.content;
            if (delta) {
              thinkingText += delta;
              finalText += delta;

              const thoughtEl = document.getElementById("thought-content");
              if (thoughtEl) thoughtEl.textContent = thinkingText;

              container.scrollTop = container.scrollHeight;
            }
          } catch {}
        }
      }
    } catch (err) {
      console.warn(err);
      keyIndex = (keyIndex + 1) % API_KEYS.length;
    }
  }

  // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø®ÙˆØ±Ø¯
  thinkingDiv.remove();
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
// Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ú©Ø§Ø±Ø¨Ø±  
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
async function sendUserMessage() {  
  const input = document.getElementById("message-input");  
  const text = input.value.trim();  
  if (!text) return;  

  let chat = getActiveChat();  
  if (!chat) {  
    createNewChat();  
    chat = getActiveChat();  
  }  

  chat.messages.push({ role: "user", content: text });  
  if (!chat.title) {  
    chat.title = text.length > 60 ? text.slice(0,57) + "â€¦" : text;  
    document.getElementById("current-title").textContent = chat.title;  
  }  
  chat.updated = Date.now();  

  input.value = "";  
  renderChat();  
  renderHistory();  
  saveChats();  

  await streamResponse(chat.messages);  
}  

function editUserMessage(idx) {  
  const chat = getActiveChat();  
  if (!chat) return;  
  const msg = chat.messages[idx];  
  document.getElementById("message-input").value = msg.content;  
  chat.messages.splice(idx, 1);  
  renderChat();  
}  

async function regenerateFrom(idx) {  
  const chat = getActiveChat();  
  if (!chat) return;  
  chat.messages = chat.messages.slice(0, idx);  
  renderChat();  
  await streamResponse(chat.messages);  
}  

function copyText(text) {  
  navigator.clipboard.writeText(text).then(() => {  
    const toast = document.createElement("div");  
    toast.className = "fixed bottom-28 left-1/2 -translate-x-1/2 bg-zinc-800 text-white px-6 py-3 rounded-2xl shadow-xl text-sm z-50";  
    toast.textContent = "Ú©Ù¾ÛŒ Ø´Ø¯ âœ“";  
    document.body.appendChild(toast);  
    setTimeout(() => toast.remove(), 1800);  
  });  
}  

function createNewChat() {  
  const newChat = {  
    id: Date.now(),  
    title: null,  
    messages: [],  
    created: Date.now(),  
    updated: Date.now()  
  };  
  allChats.push(newChat);  
  activeChatId = newChat.id;  
  saveChats();  
  document.getElementById("current-title").textContent = "Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª";  
  renderChat();  
  renderHistory();  
}  

function loadThisChat(id) {  
  activeChatId = id;  
  const chat = getActiveChat();  
  document.getElementById("current-title").textContent = chat?.title || "Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª";  
  renderChat();  
  renderHistory();  
  toggleSidebar();  
}  

function deleteCurrentChat() {  
  if (!activeChatId || !confirm("Ù…Ú©Ø§Ù„Ù…Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;  
  allChats = allChats.filter(c => c.id !== activeChatId);  
  activeChatId = null;  
  saveChats();  
  createNewChat();  
}  

function toggleSidebar() {  
  document.getElementById("sidebar").classList.toggle("translate-x-full");  
  document.getElementById("overlay").classList.toggle("hidden");  
}  

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
// Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡  
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
function initialize() {  
  if (allChats.length === 0) createNewChat();  
  else activeChatId = allChats[allChats.length-1].id;  

  const chat = getActiveChat();  
  if (chat.messages.length === 0) {  
    chat.messages.push({  
      role: "assistant",  
      content: "Ø³Ù„Ø§Ù…! Ù…Ù† Ù¾Ø§Ø±Ø³ Ø¨Ø§Øª Ù‡Ø³ØªÙ…ØŒ Ø³Ø§Ø®ØªÙ‡ Ø§Ù‡ÙˆØ±Ø§ Ù…Ø¹ØªÙ…Ø¯ÛŒ.\nÙ‡Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒ Ø¨Ù¾Ø±Ø³ØŒ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù…!"  
    });  
    saveChats();  
  }  

  renderHistory();  
  renderChat();  

  // Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø²Ø±Ú¯ Ø´Ø¯Ù† textarea  
  const ta = document.getElementById("message-input");  
  ta.addEventListener("input", () => {  
    ta.style.height = "auto";  
    ta.style.height = Math.min(ta.scrollHeight, 160) + "px";  
  });  

  // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter  
  ta.addEventListener("keydown", e => {  
    if (e.key === "Enter" && !e.shiftKey) {  
      e.preventDefault();  
      sendUserMessage();  
    }  
  });  
}  

let currentAudio = null;

function createAudioPlayer(blob) {
  const url = URL.createObjectURL(blob);

  const playerContainer = document.createElement("div");
  playerContainer.className = "flex items-center gap-2 mt-2";

  const playBtn = document.createElement("button");
  playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
  playBtn.className = "text-white";

  const seekBar = document.createElement("input");
  seekBar.type = "range";
  seekBar.min = 0;
  seekBar.value = 0;
  seekBar.step = 0.01;
  seekBar.className = "flex-1";

  const audio = new Audio(url);
  audio.preload = "metadata";

  let isPlaying = false;

  playBtn.onclick = () => {
    if (!isPlaying) {
      audio.play();
    } else {
      audio.pause();
    }
  };

  audio.onplay = () => {
    isPlaying = true;
    playBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
  };

  audio.onpause = () => {
    isPlaying = false;
    playBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
  };

  audio.ontimeupdate = () => {
    seekBar.value = audio.currentTime;
  };

  audio.onloadedmetadata = () => {
    seekBar.max = audio.duration;
  };

  seekBar.oninput = () => {
    audio.currentTime = seekBar.value;
  };

  playerContainer.appendChild(playBtn);
  playerContainer.appendChild(seekBar);

  return { container: playerContainer, audio };
}
	
async function speakText(index) {
  const chat = getActiveChat();
  if (!chat) return;

  const text = chat.messages[index].content;

  try {
    const response = await fetch("/tts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ text: text })
    });

    if (!response.ok) {
      alert("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØµØ¯Ø§");
      return;
    }

    const blob = await response.blob();

    if (currentAudio) {
      currentAudio.pause();
    }

    const { container, audio } = createAudioPlayer(blob);
    currentAudio = audio;

    const containerEl = document.getElementById("chat-container");
    containerEl.appendChild(container);
    containerEl.scrollTop = containerEl.scrollHeight;

  } catch (err) {
    console.error(err);
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù¾Ø§ÛŒØªÙˆÙ†");
  }
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ¤ Speech To Text
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {

  const recognition = new SpeechRecognition();
  recognition.lang = "fa-IR"; // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ: en-US
  recognition.interimResults = false;
  recognition.continuous = false;

  const micBtn = document.getElementById("micBtn");
  const textarea = document.getElementById("message-input");

  micBtn.addEventListener("click", () => {
    micBtn.classList.add("bg-red-600");
    recognition.start();
  });

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    textarea.value = transcript;

    // auto resize
    textarea.style.height = "auto";
    textarea.style.height = Math.min(textarea.scrollHeight, 160) + "px";
  };

  recognition.onend = () => {
    micBtn.classList.remove("bg-red-600");
  };

  recognition.onerror = () => {
    micBtn.classList.remove("bg-red-600");
    alert("Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª");
  };

} else {
  console.log("Speech Recognition Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯");
}

window.onload = initialize;

  </script>  
</body>  
</html>  
